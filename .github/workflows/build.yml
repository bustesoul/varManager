name: varManager CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'  # Initialize submodules

      - name: Read version
        id: version
        run: |
          $version = (Get-Content VERSION -TotalCount 1).Trim()
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding ascii

      - name: Prepare release metadata
        id: release_meta
        if: github.event_name == 'push'
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $tag = "V$version"
          $before = "${{ github.event.before }}"
          $after = "${{ github.sha }}"
          $files = @()
          if ($before -and ($before -notmatch '^[0]+$')) {
            $files = git diff --name-only $before $after
          } else {
            $files = git show --name-only --pretty="" $after
          }
          $versionChanged = $files -contains "VERSION"
          $tagExists = $false
          if ($versionChanged) {
            git show-ref --tags --verify --quiet "refs/tags/$tag"
            if ($LASTEXITCODE -eq 0) {
              $tagExists = $true
            }
          }
          "version_changed=$($versionChanged.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding ascii
          "tag_name=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding ascii
          "tag_exists=$($tagExists.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding ascii
          $notes = ""
          if ($versionChanged -and -not $tagExists) {
            $prevTag = git tag --list "V*" --sort=-v:refname | Select-Object -First 1
            if ([string]::IsNullOrWhiteSpace($prevTag)) {
              $log = git log -n 20 --pretty=format:"- %s (%h)"
            } else {
              $log = git log "$prevTag..HEAD" --pretty=format:"- %s (%h)"
            }
            $logText = ($log | ForEach-Object { $_ }) -join "`n"
            $notes = "Release $tag`n`nChanges:`n$logText"
          }
          "release_notes<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          $notes | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build release (Flutter + Backend)
        run: .\build.ps1 -Action release

      - name: Package release
        if: steps.release_meta.outputs.version_changed == 'true' && steps.release_meta.outputs.tag_exists != 'true' && github.event_name == 'push'
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $src = "release/varManager_$version"
          $zip = "release/varManager_$version.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Compress-Archive -Path $src -DestinationPath $zip

      - name: Create tag
        if: steps.release_meta.outputs.version_changed == 'true' && steps.release_meta.outputs.tag_exists != 'true' && github.event_name == 'push'
        run: |
          $tag = "${{ steps.release_meta.outputs.tag_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a $tag -m "Release $tag"
          git push origin $tag

      - name: Create GitHub release
        if: steps.release_meta.outputs.version_changed == 'true' && steps.release_meta.outputs.tag_exists != 'true' && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag_name }}
          name: ${{ steps.release_meta.outputs.tag_name }}
          generate_release_notes: true
          files: release/varManager_${{ steps.version.outputs.version }}.zip

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: varManager_${{ steps.version.outputs.version }}
          path: release/varManager_${{ steps.version.outputs.version }}
